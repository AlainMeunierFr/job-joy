# Deux flux :
# - Push sur la branche preprod → build, release Pre-release (preprod-vX.Y.Z)
# - Push d'un tag v* → build, release stable (vX.Y.Z)
# On build sans --publish puis on crée la release avec le bon tag (gh release create).

name: Release

on:
  push:
    branches:
      - preprod
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lire la version
        id: version
        run: |
          if ("$env:GITHUB_REF" -match '^refs/tags/v(.+)$') {
            $ver = $Matches[1]
          } else {
            $ver = (Get-Content package.json | ConvertFrom-Json).version
          }
          echo "version=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      - name: Build Electron (sans publish)
        run: npm run build:electron -- --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Déterminer le tag et le type de release
        id: release
        run: |
          $isPreprod = "$env:GITHUB_REF" -notmatch '^refs/tags/v'
          if ($isPreprod) {
            $tag = "preprod-v${{ steps.version.outputs.version }}"
            $prerelease = "true"
          } else {
            $tag = "v${{ steps.version.outputs.version }}"
            $prerelease = "false"
          }
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "prerelease=$prerelease" >> $env:GITHUB_OUTPUT
          echo "Tag: $tag (prerelease=$prerelease)"

      - name: Créer le tag (preprod uniquement)
        if: steps.release.outputs.prerelease == 'true'
        run: |
          $tag = "${{ steps.release.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $tag
          git push origin $tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publier la release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ steps.release.outputs.tag }}"
          $prerelease = "${{ steps.release.outputs.prerelease }}"
          $args = @($tag, "./dist-electron/Job-Joy-Setup.exe", "--title", "Job-Joy $tag")
          if (Test-Path "./dist-electron/Job-Joy-Setup.exe.blockmap") { $args += "./dist-electron/Job-Joy-Setup.exe.blockmap" }
          if (Test-Path "./dist-electron/latest.yml") { $args += "./dist-electron/latest.yml" }
          if ($prerelease -eq "true") { $args += "--prerelease" }
          gh release create $args
          Write-Host "Release $tag creee."
