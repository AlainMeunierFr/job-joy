# Deux flux :
# - Push sur la branche preprod → build, release Pre-release (preprod-vX.Y.Z)
# - Push d'un tag v* → build, release stable (vX.Y.Z)
# On build sans --publish puis on crée la release avec le bon tag (gh release create).

name: Release

on:
  push:
    branches:
      - preprod
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Electron
        uses: actions/cache@v4
        with:
          path: ${{ runner.workspace }}/electron-cache
          key: electron-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            electron-${{ runner.os }}-

      - name: Install dependencies
        run: npm ci
        env:
          ELECTRON_CACHE: ${{ runner.workspace }}/electron-cache

      - name: Lire la version
        id: version
        run: |
          if ("$env:GITHUB_REF" -match '^refs/tags/v(.+)$') {
            $ver = $Matches[1]
          } else {
            $ver = (Get-Content package.json | ConvertFrom-Json).version
          }
          echo "version=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      - name: Build Electron (sans publish)
        run: npm run build:electron -- --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Déterminer le tag et le type de release
        id: release
        run: |
          $isPreprod = "$env:GITHUB_REF" -notmatch '^refs/tags/v'
          if ($isPreprod) {
            $tag = "preprod-v${{ steps.version.outputs.version }}"
            $prerelease = "true"
          } else {
            $tag = "v${{ steps.version.outputs.version }}"
            $prerelease = "false"
          }
          echo "tag=$tag" >> $env:GITHUB_OUTPUT
          echo "prerelease=$prerelease" >> $env:GITHUB_OUTPUT
          echo "Tag: $tag (prerelease=$prerelease)"

      - name: Créer le tag (preprod uniquement)
        if: steps.release.outputs.prerelease == 'true'
        run: |
          $tag = "${{ steps.release.outputs.tag }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if (-not (git tag -l $tag)) { git tag $tag }
          git push origin $tag 2>&1
          if ($LASTEXITCODE -ne 0) { Write-Host "Tag peut deja exister (re-run), on continue."; exit 0 }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publier la release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ steps.release.outputs.tag }}"
          $prerelease = "${{ steps.release.outputs.prerelease }}"
          $title = if ($prerelease -eq "true") { $tag } else { "Job-Joy $tag" }
          $files = @("./dist-electron/Job-Joy-Setup.exe")
          if (Test-Path "./dist-electron/Job-Joy-Setup.exe.blockmap") { $files += "./dist-electron/Job-Joy-Setup.exe.blockmap" }
          if (Test-Path "./dist-electron/latest.yml") { $files += "./dist-electron/latest.yml" }
          $createArgs = @($tag, "--title", $title) + $files
          if ($prerelease -eq "true") { $createArgs += "--prerelease" }
          $out = gh release create $createArgs 2>&1
          $code = $LASTEXITCODE
          if ($code -ne 0 -and "$out" -match "already exists") {
            Write-Host "Release existante : mise a jour des artefacts."
            gh release upload $tag $files --clobber
            if ($prerelease -eq "true") { gh release edit $tag --prerelease }
          } elseif ($code -ne 0) {
            Write-Host $out
            exit $code
          }
          Write-Host "Release $tag OK."
