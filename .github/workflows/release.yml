# Deux flux (tous deux déclenchés par un tag) :
# - Tag preprod-v* → build complet + release Pre-release (exe généré ici).
# - Tag v* → promotion : on réutilise les artefacts de preprod-v* (pas de build), release stable = copie/colle.
# La prod est donc très rapide (~30 s).

name: Release

run-name: Release (…)

on:
  push:
    tags:
      - 'v*'
      - 'preprod-v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Nommer le run (version + pre-prod/prod)
        run: |
          if ("$env:GITHUB_REF" -match '^refs/tags/preprod-v(.+)$') { $ver = $Matches[1]; $type = "pre-prod" }
          elseif ("$env:GITHUB_REF" -match '^refs/tags/v(.+)$') { $ver = $Matches[1]; $type = "prod" }
          else { $ver = "?"; $type = "?" }
          $name = "Release $ver ($type)"
          gh api -X PATCH "repos/${{ github.repository }}/actions/runs/${{ github.run_id }}" -f name="$name"
          echo "Run name: $name"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Lire la version
        id: version
        run: |
          if ("$env:GITHUB_REF" -match '^refs/tags/preprod-v(.+)$') { $ver = $Matches[1] }
          elseif ("$env:GITHUB_REF" -match '^refs/tags/v(.+)$') { $ver = $Matches[1] }
          else { $ver = "0.0.0" }
          echo "version=$ver" >> $env:GITHUB_OUTPUT
          echo "Version: $ver"

      # --- Pre-prod : build complet (long) ---
      - name: Setup Node.js (preprod)
        if: startsWith(github.ref, 'refs/tags/preprod-')
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Electron (preprod)
        if: startsWith(github.ref, 'refs/tags/preprod-')
        uses: actions/cache@v4
        with:
          path: ${{ runner.workspace }}/electron-cache
          key: electron-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            electron-${{ runner.os }}-

      - name: Install dependencies (preprod)
        if: startsWith(github.ref, 'refs/tags/preprod-')
        run: npm ci
        env:
          ELECTRON_CACHE: ${{ runner.workspace }}/electron-cache

      - name: Build Electron (preprod)
        if: startsWith(github.ref, 'refs/tags/preprod-')
        run: npm run build:electron -- --win
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JOY_PREPROD: '1'

      # --- Prod : promotion (rapide) ---
      - name: Télécharger artefacts preprod (prod)
        if: startsWith(github.ref, 'refs/tags/v') && !startsWith(github.ref, 'refs/tags/preprod-')
        run: |
          $ver = "${{ steps.version.outputs.version }}"
          $preprodTag = "preprod-v$ver"
          gh release download $preprodTag -D ./promote-assets
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Release $preprodTag introuvable. Faire d'abord l'option 5 (pre-prod) pour cette version."
            exit 1
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publier la release (preprod)
        if: startsWith(github.ref, 'refs/tags/preprod-')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $title = $tag
          $files = @("./dist-electron/Job-Joy-Setup.exe")
          if (Test-Path "./dist-electron/Job-Joy-Setup.exe.blockmap") { $files += "./dist-electron/Job-Joy-Setup.exe.blockmap" }
          if (Test-Path "./dist-electron/latest.yml") { $files += "./dist-electron/latest.yml" }
          $createArgs = @($tag, "--title", $title) + $files + @("--prerelease")
          $out = gh release create $createArgs 2>&1
          $code = $LASTEXITCODE
          if ($code -ne 0 -and "$out" -match "already exists") {
            gh release upload $tag $files --clobber
            gh release edit $tag --prerelease
          } elseif ($code -ne 0) { Write-Host $out; exit $code }
          Write-Host "Release $tag OK."

      - name: Publier la release (prod = promotion)
        if: startsWith(github.ref, 'refs/tags/v') && !startsWith(github.ref, 'refs/tags/preprod-')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.ref_name }}"
          $title = "Job-Joy $tag"
          $dir = "promote-assets"
          $files = @(Get-ChildItem $dir -File | ForEach-Object { "$dir\$($_.Name)" })
          $createArgs = @($tag, "--title", $title) + $files
          $out = gh release create $createArgs 2>&1
          $code = $LASTEXITCODE
          if ($code -ne 0 -and "$out" -match "already exists") {
            gh release upload $tag (Get-ChildItem $dir -File | ForEach-Object { $_.FullName }) --clobber
          } elseif ($code -ne 0) { Write-Host $out; exit $code }
          Write-Host "Release $tag OK (promotion depuis preprod)."